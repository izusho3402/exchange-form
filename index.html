<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>両替伝票</title>
  <style>
    table { border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #aaa; padding: 5px; text-align: center; }
    input[type="number"] { width: 60px; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>両替伝票</h2>

  <form id="exchangeForm">
        年組:
    <select name="class" required>
      <option value="">選択してください</option>
      <option value="2-1">2-1</option>
      <option value="2-2">2-2</option>
      <option value="2-3">2-3</option>
      <option value="2-4">2-4</option>
      <option value="3-1">3-1</option>
      <option value="3-4">3-4</option>
    </select><br><br>
    名前: <input type="text" name="name" required><br><br>
    店舗:
    <select name="store" required>
      <option value="">選択してください</option>
      <option value="店舗2">第2店舗</option>
      <option value="店舗3">第3店舗</option>
      <option value="店舗4">第4店舗</option>
      <option value="店舗5">第5店舗</option>
      <option value="店舗6">第6店舗</option>
      <option value="店舗7">第7店舗</option>
    </select><br><br>
    時刻: <span id="time"></span>
    <input type="hidden" name="time" id="timeInput"><br><br>

    <table>
      <tr>
        <th>金種</th>
        <th>持参金（枚数）</th>
        <th>希望金（枚数）</th>
      </tr>
      <tr><td>1万円</td><td><input type="number" name="jisan_10000" value="0"></td><td><input type="number" name="kibou_10000" value="0"></td></tr>
      <tr><td>5千円</td><td><input type="number" name="jisan_5000" value="0"></td><td><input type="number" name="kibou_5000" value="0"></td></tr>
      <tr><td>千円</td><td><input type="number" name="jisan_1000" value="0"></td><td><input type="number" name="kibou_1000" value="0"></td></tr>
      <tr><td>500円</td><td><input type="number" name="jisan_500" value="0"></td><td><input type="number" name="kibou_500" value="0"></td></tr>
      <tr><td>100円</td><td><input type="number" name="jisan_100" value="0"></td><td><input type="number" name="kibou_100" value="0"></td></tr>
      <tr><td>50円</td><td><input type="number" name="jisan_50" value="0"></td><td><input type="number" name="kibou_50" value="0"></td></tr>
      <tr><td>10円</td><td><input type="number" name="jisan_10" value="0"></td><td><input type="number" name="kibou_10" value="0"></td></tr>
      <tr><td>5円</td><td><input type="number" name="jisan_5" value="0"></td><td><input type="number" name="kibou_5" value="0"></td></tr>
      <tr><td>1円</td><td><input type="number" name="jisan_1" value="0"></td><td><input type="number" name="kibou_1" value="0"></td></tr>
    </table>

    <p>持参金合計: <span id="sumJisan">0</span> 円</p>
    <p>希望金合計: <span id="sumKibou">0</span> 円</p>
    <p class="error" id="errorMsg"></p>

    <button type="submit">送信</button>
  </form>

  <script>
    const values = {10000:0,5000:0,1000:0,500:0,100:0,50:0,10:0,5:0,1:0};

    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      document.getElementById("time").textContent = timeStr;
      document.getElementById("timeInput").value = timeStr;
    }
    setInterval(updateTime, 1000); updateTime();

    function calcTotal() {
      let jisan = 0, kibou = 0;
      for (let key in values) {
        jisan += (document.querySelector(`[name=jisan_${key}]`).value || 0) * key;
        kibou += (document.querySelector(`[name=kibou_${key}]`).value || 0) * key;
      }
      document.getElementById("sumJisan").textContent = jisan;
      document.getElementById("sumKibou").textContent = kibou;

      if (jisan !== kibou) {
        document.getElementById("errorMsg").textContent = "持参金と希望金の合計が一致していません！";
        return false;
      } else {
        document.getElementById("errorMsg").textContent = "";
        return true;
      }
    }

    document.querySelectorAll("input[type=number]").forEach(el => {
      el.addEventListener("input", calcTotal);
    });

    const scriptURL = "https://script.google.com/macros/s/AKfycbwQ36c-a4hSi7FmBufbGvrP4txXY4r1veDScGCRzcIE0t-rwDQsvqyp_IrPSVgLmAPo/exec";
    const form = document.getElementById("exchangeForm");

    form.addEventListener("submit", async function(e) {
      e.preventDefault();
      if (!calcTotal()) {
        alert("金額が一致していません。修正してください。");
        return;
      }
      const formData = new FormData(form);
      try {
        const response = await fetch(scriptURL, { method: "POST", body: formData });
        const result = await response.text();
        if (result === "success") {
          alert("送信しました！");
          form.reset();
          updateTime();
          document.getElementById("sumJisan").textContent = "0";
          document.getElementById("sumKibou").textContent = "0";
        } else {
          alert("送信エラー: " + result);
        }
      } catch (err) {
        alert("通信エラー: " + err);
      }
    });
  </script>
</body>
</html>
